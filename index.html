<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BIG HANDS Intelligence</title>

  <!-- Fonts: Inter for text, JetBrains Mono for numbers -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #FBFBFC;
      --text: #334155;
      --muted: #94a3b8;
      --border: #e2e8f0;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-soft: 0 6px 18px rgba(15, 23, 42, 0.06);

      --themeDark: #0F172A;
      --themeAccent: #ea580c; 
      --themeAccentSoft: rgba(234, 88, 12, 0.10);
      --danger: #e11d48;
      --ok: #10b981;
      --link: #2563eb;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .mono { font-family: "JetBrains Mono", monospace; font-variant-numeric: tabular-nums; }
    .container { max-width: 1600px; margin: 0 auto; padding: 0 24px; }
    
    .topbar {
      background: var(--themeDark);
      color: #fff;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 10px 0;
      transition: background 0.5s ease;
    }
    .topbar .row { display: flex; justify-content: space-between; align-items: center; }
    .dot { width: 6px; height: 6px; border-radius: 999px; background: var(--ok); display: inline-block; margin-right: 8px; }

    header {
      position: sticky; top: 0; z-index: 30;
      background: var(--card);
      border-bottom: 1px solid rgba(226,232,240,0.6);
    }
    header .row { height: 64px; display: flex; justify-content: space-between; align-items: center; }
    
    .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: var(--themeDark);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: 900;
    }
    .brandname { font-weight: 900; text-transform: uppercase; color: #0f172a; font-size: 18px; }
    .brandname span { color: var(--themeAccent); }

    .nav { display: none; gap: 24px; font-size: 13px; font-weight: 700; }
    @media (min-width: 1024px) { .nav { display: flex; } }
    .nav a { color: #94a3b8; text-decoration: none; }
    .nav a.active { color: #0f172a; border-bottom: 2px solid #0f172a; padding-bottom: 4px; }

    .btn {
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 800;
      cursor: pointer;
      text-transform: uppercase;
    }
    .btn.pro { background: var(--themeAccent); color: #fff; border: none; }

    main { padding: 32px 0; }
    .layout { display: flex; flex-direction: column; gap: 24px; }
    @media (min-width: 1024px) {
      .layout { flex-direction: row; align-items: flex-start; }
      .left { width: 70%; }
      .right { width: 30%; position: sticky; top: 96px; }
    }

    .seg { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; gap: 4px; }
    .seg button { border: none; padding: 8px 16px; border-radius: 10px; font-size: 11px; font-weight: 800; cursor: pointer; color: #64748b; background: transparent; }
    .seg button.active { background: #fff; color: var(--themeAccent); box-shadow: var(--shadow-soft); }

    .chips { display: flex; gap: 8px; }
    .chips button { border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; cursor: pointer; background: #fff; color: #94a3b8; text-transform: uppercase; }
    .chips button.active { border-color: #0f172a; color: #0f172a; background: #f8fafc; }

    .card { background: #fff; border: 1px solid var(--border); border-radius: 20px; box-shadow: var(--shadow-soft); overflow: hidden; }
    .hero-banner { padding: 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; padding: 16px; font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; text-align: left; }
    td { padding: 18px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    tr:hover { background: #fdfdfd; cursor: pointer; }
    tr.selected { background: var(--themeAccentSoft); border-left: 4px solid var(--themeAccent); }

    .rank { color: #cbd5e1; font-weight: 800; text-align: center; }
    .ticker { font-weight: 900; font-size: 15px; color: #1e293b; }
    .pill { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    .pill.long { background: #0f172a; color: #fff; }
    .pill.short { background: #e2e8f0; color: #475569; }

    .rating { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; }
    .rating.a { background: var(--ok); color: #fff; }
    .rating.b { background: #ecfdf5; color: var(--ok); border: 1px solid #d1fae5; }
    .rating.other { background: #f8fafc; color: #94a3b8; }

    /* Right Panel Detail */
    .panel-head { padding: 24px; background: var(--themeDark); color: #fff; transition: background 0.5s ease; }
    .panel-body { padding: 24px; }
    .target-price { font-size: 42px; font-weight: 700; color: var(--link); margin: 8px 0; }
    .badge { padding: 4px 8px; border-radius: 6px; font-weight: 800; font-size: 12px; }
    .badge.up { background: #ecfdf5; color: var(--ok); }
    .badge.down { background: #fff1f2; color: var(--danger); }

    .holder-card { display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
    .holder-name { font-size: 12px; font-weight: 800; color: #334155; }

    .hide { display: none !important; }
  </style>
</head>

<body>
  <div class="topbar" id="topbar">
    <div class="container">
      <div class="row">
        <div><span class="dot"></span>Network: Live Data Analysis</div>
        <div style="font-style: italic; opacity: 0.7;">13F Smart Money Tracker</div>
      </div>
    </div>
  </div>

  <header>
    <div class="container">
      <div class="row">
        <a href="/" class="brand">
          <div class="logo">BH</div>
          <div class="brandname">BIG<span>HANDS</span></div>
        </a>
        <nav class="nav">
          <a href="#" class="active">Whale Consensus</a>
          <a href="#">Super Investors</a>
          <a href="#">Valuation Lab</a>
        </nav>
        <div class="actions">
          <button class="btn pro">Pro Access</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="layout">
      <!-- Left List -->
      <section class="left">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
          <div class="seg">
            <button id="btnBuy" class="active">▲ Top Buys</button>
            <button id="btnSell">▼ Top Sells</button>
          </div>
          <div class="chips">
            <button id="fltAll" class="active">all</button>
            <button id="fltLong">long</button>
            <button id="fltShort">short</button>
          </div>
        </div>

        <div class="card">
          <div class="hero-banner">
            <div>
              <div style="font-size:10px; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em;">Consensus Report</div>
              <h2 id="headline" style="margin:4px 0 0; font-size:20px; font-weight:900;">BUY Momentum: ALL Investors</h2>
            </div>
            <div id="updateTime" style="font-size:11px; font-weight:700; color:var(--muted);">Checking for updates...</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="text-align:center; width:60px;">#</th>
                <th>Stock Symbol</th>
                <th>Whale Activity (T/N/S)</th>
                <th style="text-align:center;">Avg. Cost</th>
                <th style="text-align:center;">Fair Value</th>
                <th style="text-align:center;">Rating</th>
              </tr>
            </thead>
            <tbody id="stockRows">
              <!-- JS maps rows here -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Right Detail -->
      <aside class="right" id="detailPanel">
        <div class="card shadow-lg">
          <div class="panel-head" id="pHead">
            <div style="display:flex; justify-content: space-between; align-items: flex-start;">
              <h3 id="pTicker" style="margin:0; font-size:22px; font-weight:900;">SELECT STOCK</h3>
              <div class="badge" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);">ANALYSIS</div>
            </div>
            <div id="pTrend" style="font-size:11px; font-weight:700; opacity:0.7; margin-top:4px; text-transform:uppercase;">Quantitative Consensus</div>
          </div>
          <div class="panel-body">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 24px;">
              <div>
                <div style="font-size:10px; font-weight:800; color:var(--muted); text-transform:uppercase;">Intrinsic Target</div>
                <div class="target-price mono" id="pTarget">$0.00</div>
              </div>
              <div class="badge mono" id="pUpside">0.0%</div>
            </div>

            <div style="margin-bottom: 24px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="font-size:11px; font-weight:800; color:var(--text);">P/E Adjustment</span>
                <span class="mono" id="pPE" style="font-weight:800; color:var(--themeAccent);">15.0x</span>
              </div>
              <input type="range" id="peSlider" min="1" max="100" step="0.5" value="15" style="width:100%; accent-color:var(--themeAccent);">
              <p style="font-size:11px; color:var(--muted); margin-top:8px; line-height:1.4;">EPS × P/E = Target. Use slider to simulate different market conditions.</p>
            </div>

            <div style="border-top:1px solid var(--border); padding-top:20px;">
              <div style="font-size:11px; font-weight:800; color:var(--muted); text-transform:uppercase; margin-bottom:12px;">Top Institutional Holders</div>
              <div id="holderList">
                <!-- Holders go here -->
              </div>
            </div>
            
            <button style="width:100%; padding:16px; border:none; border-radius:14px; background:#0f172a; color:#fff; font-weight:900; text-transform:uppercase; letter-spacing:0.1em; cursor:pointer; margin-top:20px;">Add to Watchlist</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // --- State ---
    let allData = { long: [], short: [] };
    let tradeType = 'buy'; // 'buy' | 'sell'
    let investorType = 'all'; // 'all' | 'long' | 'short'
    let selectedStock = null;
    let currentPE = 15;

    // --- DOM Elements ---
    const rowsEl = document.getElementById('stockRows');
    const headlineEl = document.getElementById('headline');
    const pTicker = document.getElementById('pTicker');
    const pTarget = document.getElementById('pTarget');
    const pUpside = document.getElementById('pUpside');
    const pPE = document.getElementById('pPE');
    const peSlider = document.getElementById('peSlider');
    const holderList = document.getElementById('holderList');

    // --- Logic ---
    async function fetchData() {
      try {
        const [longRes, shortRes] = await Promise.all([
          fetch('/top5_long.json').then(r => r.json()),
          fetch('/top5_short.json').then(r => r.json())
        ]);
        
        allData.long = longRes.top5_new_buyers || longRes.top5_sellers || [];
        allData.short = shortRes.top5_new_buyers || shortRes.top5_sellers || [];
        
        // 데이터 매핑 시 JSON 키값을 실제 변수로 연결 (수정 포인트!)
        allData.long = processRows(longRes, 'long');
        allData.short = processRows(shortRes, 'short');

        document.getElementById('updateTime').textContent = `Last Updated: ${new Date().toLocaleDateString()}`;
        render();
      } catch (err) {
        console.error("Data Load Error:", err);
        rowsEl.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:red;">Failed to load JSON data. Make sure files are in the root directory.</td></tr>';
      }
    }

    function processRows(json, type) {
      const source = tradeType === 'buy' ? (json.top5_new_buyers || []) : (json.top5_sellers || []);
      return source.map(row => ({
        ticker: row.ticker || row.symbol || 'N/A',
        name: row.name || row.issuer || 'Unknown Company',
        holders: row.holders || (Number(row.new_buyers || 0) + Number(row.sellers || 0)),
        new: row.new_buyers || 0,
        sell: row.sellers || 0,
        avgCost: row.avg_price || row.avg_cost || 0,
        currentPrice: row.current_price || row.price || 150, // Fallback for simulation
        fairValue: row.fair_value || 180,
        eps: row.eps || 5.5,
        per: row.per || row.pe_ratio || 15,
        grade: row.grade || 'B+',
        type: type,
        topHolders: row.top_holders || [
          { name: 'Institutional Alpha', type: 'Long', status: 'Increased' },
          { name: 'Global Asset Mgt', type: 'Long', status: 'New' }
        ]
      }));
    }

    function render() {
      // 1. Update Headline
      headlineEl.textContent = `${tradeType.toUpperCase()} Momentum: ${investorType.toUpperCase()} Investors`;
      
      // 2. Filter List
      let displayList = [];
      if (investorType === 'all') displayList = [...allData.long, ...allData.short];
      else if (investorType === 'long') displayList = allData.long;
      else displayList = allData.short;

      // Sort and slice top 5
      displayList.sort((a, b) => b.new - a.new || b.sell - a.sell);
      displayList = displayList.slice(0, 5);

      // 3. Render Table
      rowsEl.innerHTML = '';
      displayList.forEach((s, i) => {
        const tr = document.createElement('tr');
        if (selectedStock && selectedStock.ticker === s.ticker) tr.className = 'selected';
        
        tr.onclick = () => {
          selectedStock = s;
          currentPE = s.per;
          peSlider.value = currentPE;
          render();
        };

        tr.innerHTML = `
          <td class="rank mono">${i + 1}</td>
          <td>
            <div style="display:flex; align-items:center;">
              <span class="ticker">${s.ticker}</span>
              <span class="pill ${s.type}">${s.type === 'long' ? 'L' : 'S'}</span>
            </div>
            <div style="font-size:10px; color:var(--muted); font-weight:700; text-transform:uppercase; margin-top:2px;">${s.name}</div>
          </td>
          <td>
            <div class="mono" style="font-weight:700; font-size:13px;">${s.holders} <span style="color:var(--muted); font-weight:400; margin:0 4px;">/</span> <span style="color:var(--ok)">+${s.new}</span> <span style="color:var(--muted); font-weight:400; margin:0 4px;">/</span> <span style="color:var(--danger)">-${s.sell}</span></div>
          </td>
          <td class="mono" style="text-align:center; color:var(--muted);">$${Number(s.avgCost).toFixed(2)}</td>
          <td class="mono" style="text-align:center; font-weight:700; color:var(--link);">$${Number(s.fairValue).toFixed(2)}</td>
          <td><div class="rating ${s.grade.startsWith('A')?'a':'b'}">${s.grade}</div></td>
        `;
        rowsEl.appendChild(tr);
      });

      if (!selectedStock && displayList.length > 0) {
        selectedStock = displayList[0];
        currentPE = selectedStock.per;
        peSlider.value = currentPE;
      }

      updatePanel();
    }

    function updatePanel() {
      if (!selectedStock) return;
      
      const target = selectedStock.eps * currentPE;
      const upside = ((target - selectedStock.currentPrice) / selectedStock.currentPrice) * 100;

      pTicker.textContent = `${selectedStock.ticker} Analyst`;
      pTarget.textContent = `$${target.toFixed(2)}`;
      pPE.textContent = `${Number(currentPE).toFixed(1)}x`;
      
      pUpside.textContent = `${upside >= 0 ? '▲' : '▼'} ${Math.abs(upside).toFixed(1)}%`;
      pUpside.className = `badge mono ${upside >= 0 ? 'up' : 'down'}`;

      holderList.innerHTML = '';
      selectedStock.topHolders.forEach(h => {
        const div = document.createElement('div');
        div.className = 'holder-card';
        div.innerHTML = `
          <div>
            <div class="holder-name">${h.name}</div>
            <div style="font-size:9px; font-weight:700; color:var(--muted);">${h.type}</div>
          </div>
          <div style="font-size:10px; font-weight:800; color:var(--link);">${h.status}</div>
        `;
        holderList.appendChild(div);
      });
    }

    // --- Events ---
    document.getElementById('btnBuy').onclick = () => { tradeType = 'buy'; document.getElementById('btnBuy').className = 'active'; document.getElementById('btnSell').className = ''; fetchData(); };
    document.getElementById('btnSell').onclick = () => { tradeType = 'sell'; document.getElementById('btnSell').className = 'active'; document.getElementById('btnBuy').className = ''; fetchData(); };
    
    document.getElementById('fltAll').onclick = () => { investorType = 'all'; updateChips('fltAll'); render(); };
    document.getElementById('fltLong').onclick = () => { investorType = 'long'; updateChips('fltLong'); render(); };
    document.getElementById('fltShort').onclick = () => { investorType = 'short'; updateChips('fltShort'); render(); };

    function updateChips(id) {
      ['fltAll', 'fltLong', 'fltShort'].forEach(c => document.getElementById(c).className = (c === id ? 'active' : ''));
    }

    peSlider.oninput = (e) => {
      currentPE = e.target.value;
      updatePanel();
    };

    // --- Start ---
    fetchData();

  </script>
</body>
</html>
